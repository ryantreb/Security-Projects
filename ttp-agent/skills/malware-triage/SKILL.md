# Malware Triage Skill

## Purpose
Analyze malware samples/hashes to extract behavioral indicators, identify malware families, and enhance TTP mappings.

## Trigger
- Delegated by analyze-threat skill when malware indicators detected
- Keywords: "malware", "payload", "trojan", "ransomware", "backdoor", "RAT"
- Presence of file hashes (MD5, SHA1, SHA256)

## Input Schema
```json
{
  "guid": "parent-analysis-guid",
  "hash": {
    "type": "md5|sha1|sha256",
    "value": "hash-string"
  },
  "context": "surrounding text describing the malware",
  "source_url": "original article URL"
}
```

## Output Schema
```json
{
  "guid": "parent-analysis-guid",
  "hash": "analyzed-hash",
  "status": "identified|unknown|error",
  "malware_family": {
    "name": "string or null",
    "confidence": "high|medium|low",
    "aliases": [],
    "category": "ransomware|trojan|backdoor|rat|stealer|loader|dropper|wiper|miner|other"
  },
  "behavioral_indicators": [
    {
      "behavior": "description",
      "ttp_mapping": "T1xxx.xxx or null",
      "confidence": "high|medium|low"
    }
  ],
  "associated_iocs": [
    {
      "type": "domain|ip|url|hash|filepath|registry",
      "value": "...",
      "relationship": "c2|drop_url|persistence|lateral"
    }
  ],
  "sandbox_results": {
    "source": "source-name or null",
    "url": "link to results or null",
    "summary": "key findings"
  },
  "recommendations": [
    "detection/mitigation suggestions"
  ],
  "data_sources": [
    {
      "name": "source-name",
      "url": "source-url",
      "data_type": "sandbox|vtotal|report|advisory"
    }
  ]
}
```

---

## Execution Steps

### Step 1: Validate Input
```
1. VERIFY hash format matches declared type:
   - MD5: 32 hex characters
   - SHA1: 40 hex characters
   - SHA256: 64 hex characters
2. NORMALIZE hash to lowercase
3. IF invalid: RETURN error status
```

### Step 2: Query Public Intelligence Sources
```
NOTE: This skill uses only public, free sources.
Do NOT attempt to upload samples or access paid services.

SOURCES (query in order):

1. MalwareBazaar (abuse.ch)
   - URL: https://bazaar.abuse.ch/sample/{sha256}/
   - Data: Family, tags, delivery method

2. URLhaus (abuse.ch)
   - URL: https://urlhaus.abuse.ch/api/
   - Data: Associated URLs, distribution info

3. ThreatFox (abuse.ch)
   - URL: https://threatfox.abuse.ch/
   - Data: IOC associations, threat type

4. VirusTotal (public info only)
   - URL: https://www.virustotal.com/gui/file/{hash}
   - Data: Detection names (from page, not API)
   - NOTE: Do not use API without user-provided key

5. Malpedia (if family identified)
   - URL: https://malpedia.caad.fkie.fraunhofer.de/
   - Data: Family details, TTPs, YARA rules
```

### Step 3: Identify Malware Family
```
1. COLLECT detection names from sources
2. ANALYZE naming patterns:
   - Vendor prefixes: "Trojan.", "Ransom.", "Backdoor."
   - Family names: "Emotet", "Cobalt Strike", "QakBot"

3. DETERMINE consensus family:
   IF 3+ sources agree: confidence = "high"
   IF 2 sources agree: confidence = "medium"
   IF 1 source or conflicting: confidence = "low"

4. CATEGORIZE malware type:
   - ransomware: Encrypts files, demands payment
   - trojan: General malicious payload
   - backdoor: Provides unauthorized access
   - rat: Remote access trojan with C2
   - stealer: Exfiltrates credentials/data
   - loader: Downloads additional payloads
   - dropper: Deploys embedded payloads
   - wiper: Destroys data
   - miner: Cryptocurrency mining
   - other: Uncategorized
```

### Step 4: Extract Behavioral Indicators
```
FROM collected intelligence, identify behaviors:

1. Persistence mechanisms:
   - Registry modifications → T1547.001
   - Scheduled tasks → T1053.005
   - Service installation → T1543.003
   - Startup folder → T1547.001

2. Defense evasion:
   - Process injection → T1055
   - Obfuscation → T1027
   - Disabling security tools → T1562.001

3. Credential access:
   - LSASS memory → T1003.001
   - Browser credentials → T1555.003
   - Keylogging → T1056.001

4. Command and control:
   - HTTP(S) → T1071.001
   - DNS → T1071.004
   - Custom protocol → T1095

5. Impact:
   - Data encryption → T1486
   - Data destruction → T1485
   - System shutdown → T1529
```

### Step 5: Gather Associated IOCs
```
FROM sandbox results and threat intel:

1. Network IOCs:
   - C2 domains/IPs
   - Download URLs
   - Exfiltration endpoints

2. Host IOCs:
   - Dropped file paths
   - Registry keys modified
   - Mutex names
   - Named pipes

3. VALIDATE format for each IOC type
4. ADD relationship context (c2, persistence, etc.)
```

### Step 6: Generate Recommendations
```
BASED ON malware category and behaviors:

1. Immediate containment:
   - Network isolation recommendations
   - Process termination guidance

2. Detection opportunities:
   - Specific YARA rule suggestions
   - Network signatures
   - Behavioral indicators for EDR

3. Remediation steps:
   - Persistence removal
   - Credential reset scope
   - System recovery options
```

### Step 7: Return Results
```
COMPILE all findings into output schema
SET status based on findings:
  - "identified": Family and behaviors determined
  - "unknown": Hash not found in sources
  - "error": Query failures or invalid input
```

---

## Known Malware Family Reference

### Common Families and Their TTPs

| Family | Category | Key TTPs | C2 Pattern |
|--------|----------|----------|------------|
| Emotet | loader | T1566.001, T1059.001, T1055 | HTTP POST |
| QakBot | trojan | T1566.001, T1055, T1003 | HTTPS |
| Cobalt Strike | rat | T1059.001, T1055, T1071 | HTTP/DNS |
| Mimikatz | stealer | T1003.001, T1003.006 | N/A (tool) |
| Ryuk | ransomware | T1486, T1490, T1489 | N/A |
| TrickBot | trojan | T1055, T1003, T1071.001 | HTTPS |
| Dridex | trojan | T1566.001, T1055, T1185 | HTTPS |
| AgentTesla | stealer | T1555, T1056.001, T1041 | SMTP/FTP |
| AsyncRAT | rat | T1059.001, T1095, T1056 | TCP custom |
| Remcos | rat | T1059.001, T1055, T1056 | TCP custom |

---

## Error Handling

| Error | Action | Return Status |
|-------|--------|---------------|
| Invalid hash format | Log, return immediately | error |
| All sources timeout | Log, return partial | unknown |
| No results found | Normal - hash may be new | unknown |
| Rate limited | Wait and retry (max 2) | depends |
| Parse error on source | Log, continue with others | partial |

---

## Limitations

1. **No sample execution**: This skill does not execute malware samples
2. **No API keys required**: Uses only publicly accessible data
3. **No file uploads**: Does not submit samples to any service
4. **Rate limits apply**: Public services have query limits
5. **Stale data possible**: Public intel may be outdated

---

## Data Source Attribution

All malware intelligence must be attributed to its source:
- Include source name and URL in `data_sources` array
- Do not present aggregated data as original analysis
- Note when data is from cached/historical sources
